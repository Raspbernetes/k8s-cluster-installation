---

- name: Add Cilium Helm Repo
  community.kubernetes.helm_repository:
    name: cilium
    repo_url: "https://helm.cilium.io/"

- name: Add Cilium Helm Repo
  command:
    cmd: helm repo add cilium https://helm.cilium.io/
    creates: /usr/local/bin/helm

- name: Generate cilium helm values
  template:
    src: values.yaml.j2
    dest: /root/values.yaml
    mode: 0644

- name: Deploy Cilium
  community.kubernetes.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    chart_version: {{ cni_cilium_helm_version }}
    values_files:
      - /root/values.yaml

# TODO: Only deploy kube-router if enabled
- name: Create Manifests Directory
  file:
    path: /root/manifests
    state: directory
    mode: 0700

- name: "Generate kube-router manifests"
  become: true
  template:
    src: "{{ item }}"
    dest: "/root/manifests/{{ item | basename | replace('.j2','') }}"
    mode: 0600
  with_items:
  - "generic-kuberouter-only-advertise-routes.yaml.j2"

- name: Apply kube-router manifests
  command:
    cmd: "kubectl apply -f /root/manifests/{{ item }}"
  with_items:
  - "generic-kuberouter-only-advertise-routes.yaml"

- name: Remove Manifests Directory
  file:
    path: /root/manifests
    state: absent
