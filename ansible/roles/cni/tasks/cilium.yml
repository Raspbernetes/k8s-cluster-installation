---

- name: mount sys-fs-bpf
  ansible.posix.mount:
    path: /sys/fs/bpf
    src: bpffs
    opts: rw,nosuid,nodev,noexec,relatime,mode=700
    state: mounted
    fstype: bpf

- name: add Cilium Helm Repo
  community.kubernetes.helm_repository:
    name: cilium
    repo_url: "https://helm.cilium.io/"

- name: deploy Cilium
  community.kubernetes.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    chart_version: "{{ cni_cilium_helm_version }}"
    values: "{{ lookup('template', 'values.yaml.j2') | from_yaml }}"

- name: patch cilium-operator for helm chart bug
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: cilium-operator
        namespace: kube-system
      spec:
        template:
          spec:
            containers:
              - name: cilium-operator
                image: cilium/operator-dev:{{ cni_cilium_image_version }}


- name: Apply kube-router manifests
  community.kubernetes.k8s:
    state: present
    template: 'generic-kuberouter-only-advertise-routes.yaml.j2'
  when:
    - cni_kube_router_enabled
